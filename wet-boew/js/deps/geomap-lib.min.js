/*
 * @title WET-BOEW Geomap
 * @overview Displays a dynamic map over which information from additional sources can be overlaid.
 * @license wet-boew.github.io/wet-boew/License-en.html / wet-boew.github.io/wet-boew/Licence-fr.html
 * @author @pjackson28
 */
!function(a,b,c,d){"use strict";var e,f,g="wb-geomap",h="."+g,i=d.doc,j=0,k=[],l={overlays:[],tables:[],useScaleLine:!1,useMousePosition:!1,useLegend:!1,useTab:!1,useMapControls:!0,useGeocoder:!1,useGeolocation:!1,useAOI:!1},m=function(b){var c,h,i=b.target,j=i.className,m={};b.currentTarget===i&&(c=a(i),f||(e=d.i18n,f={add:e("add"),close:e("close"),colon:e("colon"),err:e("err"),hiddenLayer:e("geo-hdnlyr"),toggleLayer:e("geo-tgllyr"),labelSelect:e("geo-lblsel"),select:e("geo-sel"),zoomFeature:e("geo-zmfeat"),zoomin:e("geo-zmin"),zoomout:e("geo-zmout"),zoomworld:e("geo-zmwrld"),baseMapTitle:e("geo-bmapttl"),baseMapURL:e("geo-bmapurl"),baseMapURLTxt:e("geo-bmapurltxt"),scaleline:e("geo-sclln"),mouseposition:e("geo-msepos"),access:e("geo-ally"),accessTitle:e("geo-allyttl"),attribLink:e("geo-attrlnk"),attribTitle:e("geo-attrttl"),ariaMap:e("geo-ariamap"),geoLocationURL:e("geo-locurl-geogratis"),geoCoderPlaceholder:e("geo-loc-placeholder"),geoCoderLabel:e("geo-loc-label"),aoiNorth:e("geo-aoi-north"),aoiEast:e("geo-aoi-east"),aoiSouth:e("geo-aoi-south"),aoiWest:e("geo-aoi-west"),aoiInstructions:e("geo-aoi-instructions"),aoiBtnDraw:e("geo-aoi-btndraw"),aoiBtnClear:e("geo-aoi-btnclear"),aoiBtnClose:e("close"),geolocBtn:e("geo-geoloc-btn"),geolocFail:e("geo-geoloc-fail"),geolocUncapable:e("geo-geoloc-uncapable"),geoLgndGrphc:e("geo-lgnd-grphc"),dismiss:e("dismiss")}),h={useScaleLine:j.indexOf(" scaleline ")!==-1||void 0,useMousePosition:j.indexOf(" position ")!==-1||void 0,useLegend:j.indexOf(" legend ")!==-1,useMapControls:j.indexOf(" static ")===-1,useGeocoder:j.indexOf(" geocoder ")!==-1,useGeolocation:j.indexOf(" geolocation ")!==-1,useAOI:j.indexOf(" aoi ")!==-1},a.extend(m,l,h,d.getData(c,g)),m.layersFile?a.ajax({url:m.layersFile,async:!0,dataType:"script",success:function(){m=a.extend(m,wet_boew_geomap),k.push(new n({target:c,settings:m}))}}):k.push(new n({target:c,settings:m}))),d.getMap=function(a){return H(a)}},n=function(b){var c=b.target,d={};this.id=c.attr("id"),this.mapLayers=[],this.layerDiv=c.find(".wb-geomap-layers").attr("id","geomap-layers-"+this.id),this.legendDiv=c.find(".wb-geomap-legend").attr("id","geomap-legend-"+this.id),this.mapDiv=c.find(".wb-geomap-map").attr("id","geomap-map-"+this.id),this.settings=b.settings,this.settings.aspectRatio=this.settings.basemap&&this.settings.basemap.mapOptions&&void 0!==this.settings.basemap.mapOptions.aspectRatio?this.settings.basemap.mapOptions.aspectRatio:.8,this.map=G(this),this.legend=new p(this),d=this.addBasemap(),this.map.setView(new ol.View(d)),this.addMapLayers(),d.extent&&this.map.getView().fit(d.extent,this.map.getSize()),this.loadControls(),this.accessibilize(),this.createPopup(),i.on("wb-ready.wb-geomap","#"+this.id,function(){a("#"+this.id).find(".geomap-progress").remove()})},o=function(a,b){return this.map=a,this.settings=b,this.id=this.settings.tableId?this.settings.tableId:Q(),this.layer=this.createOLLayer(),this.settings.accessible="undefined"==typeof this.settings.accessible||this.settings.accessible,this.settings.visible="undefined"==typeof this.settings.visible||this.settings.visible,this.settings.zoom="undefined"==typeof this.settings.zoom||this.settings.zoom,this.settings.accessible&&this.map.layerDiv.append("<section class='panel panel-default'><div class='panel-heading'><h4 class='panel-title'>"+this.settings.title+"</h4></div><div class='panel-body'><div data-layer='"+this.id+"' class='geomap-table-wrapper' style='display:none;'></div></div></section>"),0!==this.map.legendDiv.length&&this.addToLegend(),this.toggleVisibility(this.settings.visible),this},p=function(b){return this.map=b,this.symbolMapArray=[],this.target=a("#"+b.id+".wb-geomap").find(".wb-geomap-legend"),this.target.attr("id","geomap-legend-"+b.id),this.target.empty(),this},q=function(a,b){var c;return a.getInteractions().forEach(function(a){a instanceof b&&(c=a)}),c},r=function(b,c,d,e,f){var g,h,i,j,k,l,m,n=d.getGeometry().getExtent(),o=ol.extent.getWidth(n),p=ol.extent.getHeight(n),q=a("#"+b);k=1,k||(k=Math.max(o/e||0,p/f||0)||1),c.setView(new ol.View({minResolution:k,maxResolution:k,projection:new ol.proj.Projection({code:"",units:"pixels"})})),m=Math.max(e,o/k),l=Math.max(f,p/k),j=ol.extent.getCenter(n),g=m*k/2,h=l*k/2,i=[j[0]-g,j[1]-h,j[0]+g,j[1]+h],q.width(Math.round(m)),q.height(Math.round(l)),c.updateSize(),c.getView().fit(i,c.getSize())},s=function(){var a=z(d.drawColours[j],.5),b=z(d.drawColours[j],1),c={fill:a,stroke:b,transparent:[0,0,0,0]};return j+=1,j===d.drawColours.length&&(j=0),c},t=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m=s();this.createStyleFunction=function(a,b){return e=a,b=b,f=e&&e.type?e.type:"default",function(a){return"rule"===f?new n(a,b):"symbol"===f?new o:"default"===f?new p(a,b):"unique"===f?new q(a,b):void 0}};var n=function(f){for(var n,o,p=e.rule,q=p.length,r={EQUAL_TO:function(a,b){return String(a)===String(b[0])},GREATER_THAN:function(a,b){return a>b[0]},LESS_THAN:function(a,b){return a<b[0]},BETWEEN:function(a,b){return a>=b[0]&&a<=b[1]}},s=f&&f.getGeometry()?f.getGeometry().getType():"Polygon",t=0;t!==q;t+=1)if(n=p[t],o=n.filter,k=n.init.strokeDash?n.init.strokeDash:[1,0],l=n.init.strokeWidth?n.init.strokeWidth:1,h=n.init.fillOpacity?n.init.fillOpacity:.5,i=n.init.pointRadius?n.init.pointRadius:5,j=n.init.strokeColor?z(n.init.strokeColor,h):m.transparent,g=z(n.init.fillColor,h),d=n.init.graphicName?n.init.graphicName:null,a=n.init.externalGraphic?n.init.externalGraphic:null,b=n.init.graphicHeight?n.init.graphicHeight:25,c=n.init.graphicWidth?n.init.graphicWidth:25,r[o](f.attributes[n.field],n.value))switch(s){case"Polygon":return x({fill:new ol.style.Fill({color:g}),stroke:new ol.style.Stroke({color:j,width:l,lineDash:k})});case"Point":return d?u({symbol:d,fill:new ol.style.Fill({color:g}),stroke:new ol.style.Stroke({color:j,lineDash:k}),radius:i}):a?v({src:a,opacity:h,size:[c,b]}):w({radius:i,fill:new ol.style.Fill({color:g}),stroke:new ol.style.Stroke({color:j,width:l,lineDash:k})});case"LineString":return y({stroke:new ol.style.Stroke({color:j,width:l,lineDash:k})});default:return x({fill:new ol.style.Fill({color:g}),stroke:new ol.style.Stroke({color:j,width:l,lineDash:k})})}},o=function(){return h=e.init.fillOpacity?e.init.fillOpacity:e.init.graphicOpacity?e.init.graphicOpacity:1,i=e.init.pointRadius?e.init.pointRadius:5,j=e.init.strokeColor?z(e.init.strokeColor,h):m.transparent,g=z(e.init.fillColor,h),d=e.init.graphicName?e.init.graphicName:null,a=e.init.externalGraphic?e.init.externalGraphic:null,b=e.init.graphicHeight?e.init.graphicHeight:25,c=e.init.graphicWidth?e.init.graphicWidth:25,d?u({symbol:e.init.graphicName,fill:new ol.style.Fill({color:g}),stroke:new ol.style.Stroke({color:j,lineDash:k}),radius:i}):a?v({src:a,opacity:h,size:[c,b]}):w({radius:i,fill:new ol.style.Fill({color:g}),stroke:new ol.style.Stroke({color:j,width:l})})},p=function(){return h=e.fillOpacity?e.fillOpacity:1,g=e.fillColor?z(e.fillColor,h):m.transparent,j=e.strokeColor?z(e.strokeColor,h):m.transparent,l=e.strokeWidth?e.strokeWidth:1,k=e.strokeDash?e.strokeDash:[1,0],[new ol.style.Style({image:new ol.style.Circle({fill:new ol.style.Fill({color:g}),stroke:new ol.style.Stroke({color:j,width:l,lineDash:k}),radius:5}),fill:new ol.style.Fill({color:g}),stroke:new ol.style.Stroke({color:j,width:l,lineDash:k})})]},q=function(d,f){var n,o,p=e.field;for(n in e.init)switch(o=e.init[n],k=o.strokeDash?o.strokeDash:[1,0],l=o.strokeWidth?o.strokeWidth:1,h=o.fillOpacity?o.fillOpacity:.5,i=o.pointRadius?o.pointRadius:5,j=o.strokeColor?z(o.strokeColor,h):m.transparent,g=o.fillColor?z(o.fillColor,h):null,name=o.name?o.name:null,b=o.graphicHeight?o.graphicHeight:25,a=o.externalGraphic,c=o.graphicWidth?o.graphicWidth:25,f){case"Polygon":if(d.attributes&&d.attributes[p]===n)return x({fill:new ol.style.Fill({color:g}),stroke:new ol.style.Stroke({color:j,width:l,lineDash:k})});break;case"Point":if(a){if(d.attributes&&d.attributes[p]===n)return v({src:a,opacity:h,size:[c,b]})}else if(d.attributes&&d.attributes[p]===n)return w({radius:i,fill:new ol.style.Fill({color:g}),stroke:new ol.style.Stroke({color:j,width:l,lineDash:k})});break;case"LineString":if(d.attributes&&d.attributes[p]===n)return y({stroke:new ol.style.Stroke({color:j,width:l,lineDash:k})});break;default:if(d.attributes&&d.attributes[p]===n)return x({fill:new ol.style.Fill({color:g}),stroke:new ol.style.Stroke({color:j,width:l,lineDash:k})})}}},u=function(a){var b={square:[new ol.style.Style({image:new ol.style.RegularShape({fill:a.fill,stroke:a.stroke,points:4,radius:a.radius,angle:Math.PI/4})})],triangle:[new ol.style.Style({image:new ol.style.RegularShape({fill:a.fill,stroke:a.stroke,points:3,radius:a.radius,rotation:Math.PI/4,angle:0})})],star:[new ol.style.Style({image:new ol.style.RegularShape({fill:a.fill,stroke:a.stroke,points:5,radius:a.radius,radius2:.4*a.radius,angle:0})})],cross:[new ol.style.Style({image:new ol.style.RegularShape({fill:a.fill,stroke:a.stroke,points:4,radius:a.radius,radius2:0,angle:0})})],x:[new ol.style.Style({image:new ol.style.RegularShape({fill:a.fill,stroke:a.stroke,points:4,radius:a.radius,radius2:0,angle:Math.PI/4})})]};return b[a.symbol]},v=function(a){return[new ol.style.Style({image:new ol.style.Icon({opacity:a.opacity,src:a.src,size:a.size})})]},w=function(a){return[new ol.style.Style({image:new ol.style.Circle({radius:a.radius,fill:a.fill,stroke:a.stroke})})]},x=function(a){return[new ol.style.Style({fill:a.fill,stroke:a.stroke})]},y=function(a){return[new ol.style.Style({stroke:a.stroke})]},z=function(a,b){var c=(a+"").trim(),d=null,e=c.match(/^#?(([0-9a-zA-Z]{3}){1,3})$/),f=b?b:1;return e?(c=e[1],6===c.length?d=[parseInt(c.substring(0,2),16),parseInt(c.substring(2,4),16),parseInt(c.substring(4,6),16),f]:3===c.length&&(d=[parseInt(c.substring(0,1)+c.substring(0,1),16),parseInt(c.substring(1,2)+c.substring(1,2),16),parseInt(c.substring(2,3)+c.substring(2,3),16),f]),d):a},A=function(a,b){return"<td><label class='wb-inv' for='cb_"+b.getId()+"'>"+f.labelSelect+"</label><input type='checkbox' id='cb_"+b.getId()+"' class='geomap-cbx' data-map='"+a.map.id+"' data-layer='"+b.layerId+"' data-feature='"+b.getId()+"' /></td>"},B=function(a,b){return"<td class='text-right'><a href='javascript:;' data-map='"+a.map.id+"' data-layer='"+b.layerId+"' data-feature='"+b.getId()+"' class='btn btn-link geomap-zoomto' alt='"+f.zoomFeature+"' role='button'><span class='glyphicon glyphicon-zoom-in'></span></a></td>"},C=function(b,d,e){if(d){var f=e.getOverlays().getArray()[0],g=a(c.getElementById("popup-geomap-map-"+e.id)),h="",i=O(e,d.layerId);if(d&&d.attributes){var j,k,l=d.getGeometry(),m="Point"===l.getType()?l.getCoordinates():b.mapBrowserEvent.coordinate,n=d.attributes;if(i.popupsInfo){h+=i.popupsInfo.content;for(j in n)n.hasOwnProperty(j)&&(k=new RegExp("_"+j,"igm"),h=h.replace(k,n[j]))}else for(j in n)n.hasOwnProperty(j)&&(h+="<tr><th><strong>"+j+"</strong></th><td> "+n[j]+"</td></tr>");g.find(".popup-content").html("<h5>"+d.layerTitle+"</h5><table style='width:100%;'>"+h+"</table>"),f.setPosition(m)}else f.setPosition(void 0)}},D=function(a){var b,c={};for(b in a)a.hasOwnProperty(b)&&"type"!==b&&"caption"!==b&&"url"!==b&&"title"!==b&&(c[b]=a[b]);return c},E=function(b,c){var d,e={};for(d in b)b.hasOwnProperty(d)&&a.inArray(d,c)<0&&(e[d]=b[d]);return e},F=function(a){var b,c={};for(b in a)a.hasOwnProperty(b)&&null!==a[b]&&(c[b]=a[b]);return c},G=function(b){proj4.defs("EPSG:3978","+proj=lcc +lat_1=49 +lat_2=77 +lat_0=49 +lon_0=-95 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs"),proj4.defs("urn:ogc:def:crs:OGC:1.3:CRS84",proj4.defs("EPSG:4326"));var c=new ol.Map({controls:ol.control.defaults({attributionOptions:{collapsible:!1}}),interactions:ol.interaction.defaults({mouseWheelZoom:!0}),logo:!1,target:b.mapDiv.attr("id")});return b.mapDiv.height(b.mapDiv.width()*b.settings.aspectRatio),c.set("aspectRatio",b.settings.aspectRatio),c.id=b.id,c.once("postrender",function(){d.ready(a("#"+b.id),g,[c])}),c.on("moveend",function(){a(b.id).trigger("wb-updated"+h,[b.map])}),c},H=function(a){var b,c;for(c=k.length-1;c!==-1;c-=1)if(b=k[c],b.id===a)return b},I=function(b){function c(a,b){var c,d,e,f=[],g=new ol.proj.Projection({code:"EPSG:4326"}),h=a.map.getView().getProjection();for(c=M(parseFloat(b[0]),parseFloat(b[1]),parseFloat(b[2]),parseFloat(b[3])),d=c.length-1;d!==-1;d-=1)f.push([c[d].getCoordinates()[0],c[d].getCoordinates()[1]]);return e=new ol.Feature({geometry:new ol.geom.Polygon([f]).transform(g,h)}),O(a.map,"locLayer").getSource().addFeature(e),e}var d=new ol.interaction.DragBox,e=new ol.proj.Projection({code:"EPSG:4326"}),g=b.map.getView().getProjection();d.on("boxend",function(){var f=d.getGeometry().transform(g,e).getExtent();n=c(b,f),b.map.getView().fit(n.getGeometry().getExtent(),b.map.getSize()),a("#geomap-aoi-minx-"+b.id).val(f[0]),a("#geomap-aoi-maxx-"+b.id).val(f[2]),a("#geomap-aoi-maxy-"+b.id).val(f[3]),a("#geomap-aoi-miny-"+b.id).val(f[1]),a("#geomap-aoi-extent-"+b.id).val(n.getGeometry().getExtent()).trigger("change"),a("#geomap-aoi-extent-lonlat-"+b.id).val(f[0]+", "+f[1]+", "+f[2]+", "+f[3]).trigger("change")}),d.on("boxstart",function(){O(b.map,"locLayer").getSource().clear(!0)}),b.map.addInteraction(d),d.setActive(!1),b.mapDiv.before("<div class='geomap-aoi panel panel-default'><div id='geomap-aoi-"+b.id+"' class='panel-body'></div></div>");var h,j,k,l,m,n,o=a("#geomap-aoi-"+b.id);o.append("<fieldset id='form-aoi-"+b.id+"'><legend tabindex='-1'>"+f.aoiInstructions+"</legend><div class='row'><div class='col-md-2'><label for='geomap-aoi-maxy-"+b.id+"' class='wb-inv'>"+f.aoiNorth+"</label><div class='input-group input-group-sm'><span class='input-group-addon'>"+f.aoiNorth.charAt(0)+"</span><input type='number' id='geomap-aoi-maxy-"+b.id+"' placeholder='90' class='form-control input-sm' min='-90' max='90' step='0.000001'></input></div></div><div class='col-md-2'><label for='geomap-aoi-maxx-"+b.id+"' class='wb-inv'>"+f.aoiEast+"</label><div class='input-group input-group-sm'><span class='input-group-addon'>"+f.aoiEast.charAt(0)+"</span><input type='number' id='geomap-aoi-maxx-"+b.id+"' placeholder='180' class='form-control input-sm' min='-180' max='180' step='0.000001'></input> </div></div><div class='col-md-2'><label for='geomap-aoi-miny-"+b.id+"' class='wb-inv'>"+f.aoiSouth+"</label><div class='input-group input-group-sm'><span class='input-group-addon'>"+f.aoiSouth.charAt(0)+"</span><input type='number' id='geomap-aoi-miny-"+b.id+"' placeholder='-90' class='form-control input-sm' min='-90' max='90' step='0.000001'></input> </div></div><div class='col-md-2'><label for='geomap-aoi-minx-"+b.id+"' class='wb-inv'>"+f.aoiWest+"</label><div class='input-group input-group-sm'><span class='input-group-addon'>"+f.aoiWest.charAt(0)+"</span><input type='number' id='geomap-aoi-minx-"+b.id+"' placeholder='-180' class='form-control input-sm' min='-180' max='180' step='0.000001'></input> </div></div><div class='col-md-4'><button class='btn btn-default btn-sm' id='geomap-aoi-btn-draw-"+b.id+"'>"+f.add+"</button> <button class='btn btn-default btn-sm' id='geomap-aoi-btn-clear-"+b.id+"'>"+f.aoiBtnClear+"</button> </div></div><input type='hidden' id='geomap-aoi-extent-"+b.id+"'></input><input type='hidden' id='geomap-aoi-extent-lonlat-"+b.id+"'></input></fieldset></div><div class='clear'></div>"),a("#geomap-aoi-btn-clear-"+b.id).after("<button id='geomap-aoi-toggle-mode-draw-"+b.id+"' href='#' class='btn btn-sm btn-default geomap-geoloc-aoi-btn' title='"+f.aoiBtnDraw+"'><i class='glyphicon glyphicon-edit'></i> "+f.aoiBtnDraw+"</button>"),i.on("click","#geomap-aoi-toggle-mode-draw-"+b.id,function(c){c.preventDefault();var e=q(b.map,ol.interaction.DragBox),f=q(b.map,ol.interaction.Select),g=d.getActive(),h=a("#geomap-aoi-"+b.id);a(this).toggleClass("active"),g||h.find("legend").trigger("setfocus.wb"),e.setActive(!g),f.setActive(g)}),i.on("click","#geomap-aoi-btn-clear-"+b.id,function(c){c.preventDefault(),a("#geomap-aoi-extent-"+b.id).val(""),a("#geomap-aoi-extent-lonlat-"+b.id).val(""),a("#geomap-aoi-minx-"+b.id).val("").parent().removeClass("has-error"),a("#geomap-aoi-miny-"+b.id).val("").parent().removeClass("has-error"),a("#geomap-aoi-maxx-"+b.id).val("").parent().removeClass("has-error"),a("#geomap-aoi-maxy-"+b.id).val("").parent().removeClass("has-error"),O(b.map,"locLayer").getSource().clear(!0)}),i.on("click","#geomap-aoi-btn-draw-"+b.id,function(d){d.preventDefault(),a("#geomap-aoi-extent-"+b.id).val(""),a("#geomap-aoi-extent-lonlat-"+b.id).val(""),a("#geomap-aoi-minx-"+b.id).parent().removeClass("has-error"),a("#geomap-aoi-maxx-"+b.id).parent().removeClass("has-error"),a("#geomap-aoi-maxy-"+b.id).parent().removeClass("has-error"),a("#geomap-aoi-miny-"+b.id).parent().removeClass("has-error"),O(b.map,"locLayer").getSource().clear(!0);var e,f,g=parseFloat(a("#geomap-aoi-minx-"+b.id).val()),h=parseFloat(a("#geomap-aoi-miny-"+b.id).val()),i=parseFloat(a("#geomap-aoi-maxx-"+b.id).val()),j=parseFloat(a("#geomap-aoi-maxy-"+b.id).val()),k=!0;return(!g||g<-180||g>180)&&(a("#geomap-aoi-minx-"+b.id).parent().addClass("has-error"),k=!1),(!i||i<-180||i>180)&&(a("#geomap-aoi-maxx-"+b.id).parent().addClass("has-error"),k=!1),(!j||j<-90||j>90)&&(a("#geomap-aoi-maxy-"+b.id).parent().addClass("has-error"),k=!1),(!h||h<-90||h>90)&&(a("#geomap-aoi-miny-"+b.id).parent().addClass("has-error"),k=!1),k!==!1&&(f=[g,h,i,j],e=c(b,f),b.map.getView().fit(e.getGeometry().getExtent(),b.map.getSize()),a("#geomap-aoi-extent-"+b.id).val(e.getGeometry().getExtent()).trigger("change"),void a("#geomap-aoi-extent-lonlat-"+b.id).val(g+", "+h+", "+i+", "+j).trigger("change"))}),b.aoiExtent&&(h=b.aoiExtent.split(","),j=h[0].trim(),k=h[1].trim(),l=h[2].trim(),m=h[3].trim(),n=c(b,h),b.map.getView().fit(n.getGeometry().getExtent(),b.map.getSize()),a("#geomap-aoi-minx-"+b.id).val(j),a("#geomap-aoi-maxx-"+b.id).val(l),a("#geomap-aoi-maxy-"+b.id).val(m),a("#geomap-aoi-miny-"+b.id).val(k),a("#geomap-aoi-extent-"+b.id).val(n.getBounds().toBBOX()),a("#geomap-aoi-extent-lonlat-"+b.id).val(j+", "+k+", "+l+", "+m))},J=function(b){var d=c.createElement("button"),e=c.createElement("div");d.innerHTML="?",d.title=f.accessTitle,d.addEventListener("click",function(){var d=c.createElement("div"),e=c.createElement("header"),g=c.createElement("h3"),h=c.createElement("a"),i=c.createElement("div"),j=c.createAttribute("role"),k=c.createAttribute("title"),l=c.createAttribute("href");d.className="panel panel-default geomap-help-dialog ol-control ",e.className="panel-heading",g.innerHTML=f.accessTitle,g.className="panel-title",e.appendChild(g),k.value=f.dismiss,h.setAttributeNode(k),l.value="#",h.setAttributeNode(l),j.value="button",h.setAttributeNode(j),h.innerHTML="&#xd7;<span class='wb-inv'>"+f.dismiss+"</span>",h.className="btn btn-link",d.appendChild(h),i.innerHTML="<p>"+f.access+"</p>",i.className="panel-body",d.appendChild(e),d.appendChild(i);var m=new ol.control.Control({element:d});h.addEventListener("click",function(c){c.preventDefault(),a(c.target).closest(".geomap-help-dialog").fadeOut(function(){b.map.removeControl(m)})}),b.map.addControl(m)},!1),e.className="geomap-help-btn ol-unselectable ol-control",e.appendChild(d),ol.control.Control.call(this,{element:e}),b.map.addControl(this)},K=function(b){var d,e,g=c.createElement("div");g.innerHTML="<label for='wb-geomap-geocode-search-"+b.id+"' class='wb-inv'>"+f.geoCoderLabel+"</label><input type='text' class='form-control opct-90 input-sm' name='wb-geomap-geocode-search-"+b.id+"' id='wb-geomap-geocode-search-"+b.id+"' list='wb-geomap-geocode-results-"+b.id+"' autocomplete='off' placeholder='"+f.geoCoderPlaceholder+"' /><datalist id='wb-geomap-geocode-results-"+b.id+"'></datalist>",g.className="geomap-geoloc ol-unselectable ol-control",ol.control.Control.call(this,{element:g}),b.map.addControl(this),a("#wb-geomap-geocode-search-"+b.id).trigger("wb-init.wb-datalist"),i.on("keypress","#wb-geomap-geocode-search-"+b.id,function(c){if(13===c.keyCode){var d,e,f,g,h,i,j,k,l=[],m=new ol.proj.Projection({code:"EPSG:4326"}),n=b.map.getView().getProjection();if(O(b.map,"locLayer").getSource().clear(!0),j=a("#wb-geomap-geocode-search-"+b.id).val(),!j)return a("#wb-geomap-geocode-search-"+b.id).parent().addClass("has-error"),void setTimeout(function(){a("#wb-geomap-geocode-search-"+b.id).parent().removeClass("has-error")},5e3);if(d=a("#wb-geomap-geocode-results-"+b.id+" option").filter(function(){return this.value===j}).data("bbox"),i=a("#wb-geomap-geocode-results-"+b.id+" option").filter(function(){return this.value===j}).data("lat-lon"),null!==d){for(e=d.split(","),f=M(parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3])),h=f.length-1;h!==-1;h-=1)l.push([f[h].getCoordinates()[0],f[h].getCoordinates()[1]]);g=new ol.Feature({geometry:new ol.geom.Polygon([l]).transform(m,n)}),O(b.map,"locLayer").getSource().addFeature(g),b.map.getView().fit(g.getGeometry().getExtent(),b.map.getSize())}else null!==i&&(k=0===b.map.getView().getZoom()?12:b.map.getView().getZoom(),g=new ol.Feature({geometry:new ol.geom.Point(i.split(",")).transform(m,n)}),O(b.map,"locLayer").getSource().addFeature(g),b.map.getView().setZoom(k),b.map.getView().setCenter(g.getGeometry().getCoordinates()))}}),i.on("keyup","#wb-geomap-geocode-search-"+b.id,function(c){var g,h,i,j,k,l=a("#wb-geomap-geocode-results-"+b.id),m=[];a(this).parent().removeClass("has-error"),g=a(this).val().trim(),k=c.which,""===g||g.length<=2||13===k||9===k||40===k||39===k||38===k||(d&&d.abort(),clearTimeout(e),e=setTimeout(function(){d=a.get(f.geoLocationURL,{q:g+"*"},function(c){if(m="<!--[if lte IE 9]><select><![endif]-->",c.length)for(var d=0,e=c.length;d<e;d++)j=c[d].title.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),h=c[d].bbox?c[d].bbox[0]+", "+c[d].bbox[1]+", "+c[d].bbox[2]+", "+c[d].bbox[3]:null,i=c[d].geometry&&"Point"===c[d].geometry.type?c[d].geometry.coordinates[0]+", "+c[d].geometry.coordinates[1]:null,m+="<option value='"+j+"' data-lat-lon='"+i+"' data-bbox='"+h+"' data-type='"+c[d].type+"'></option>",d===e-1&&(m+="<!--[if lte IE 9]></select><![endif]-->",l.html(m));a(".geomap-geoloc .wb-al-cnt").length>0&&(a("#wb-geomap-geocode-search-"+b.id).removeClass("wb-datalist-inited"),a("#wb-geomap-geocode-results-"+b.id).remove(),a("#wb-al-wb-geomap-geocode-search-"+b.id).remove(),a("#wb-al-wb-geomap-geocode-search-"+b.id+"-src").remove(),a("#wb-geomap-geocode-search-"+b.id).after(l),a("#wb-geomap-geocode-search-"+b.id).trigger("wb-init.wb-datalist"))},"jsonp")},500))})},L=function(b){function d(){return g=new ol.Feature,e=new ol.Feature,g.setStyle(w({radius:6,fill:new ol.style.Fill({color:"#3399CC"}),stroke:new ol.style.Stroke({color:"#fff",width:2})})),[e,g]}var e,g,h,i,j,k=b||{},l=this;a("body").append("<section id='overlay-location-error' class='wb-overlay modal-content overlay-def wb-bar-t bg-danger'><header><h2 class='modal-title'>Geolocation error.</h2></header></section>"),a("#overlay-location-error").trigger("wb-init.wb-overlay"),h=c.createElement("button"),h.setAttribute("type","button"),h.setAttribute("title",f.geolocBtn),h.innerHTML="<span class='glyphicon glyphicon-screenshot'></span>",j=c.createElement("div"),j.className="ol-geolocate ol-unselectable ol-control",j.appendChild(h),l.geolocation=new ol.Geolocation(k),ol.control.Control.call(this,{element:j,target:k.target}),l.geolocation.on("change:accuracyGeometry",function(){e.setGeometry(l.geolocation.getAccuracyGeometry())}),l.geolocation.on("change:position",function(){i=l.geolocation.getPosition(),g.setGeometry(i?new ol.geom.Point(i):null);var a=l.featuresOverlay.getSource().getExtent();l.getMap().getView().fit(a,l.getMap().getSize())}),l.geolocation.on("error",function(b){2===b.code?(a("#overlay-location-error h2.modal-title").text(f.geolocUncapable),a("#overlay-location-error").trigger("open.wb-overlay")):(a("#overlay-location-error h2.modal-title").text(f.geolocFail),a("#overlay-location-error").trigger("open.wb-overlay"))}),h.addEventListener("click",function(){"undefined"==typeof l.featuresOverlay?(l.featuresOverlay=new ol.layer.Vector({map:l.getMap(),source:new ol.source.Vector({})}),l.featuresOverlay.getSource().addFeatures(d()),l.geolocation.setTracking(!0),a(this).html("<span style='color:green;' class='glyphicon glyphicon-screenshot'></span>")):0===l.featuresOverlay.getSource().getFeatures().length?(l.featuresOverlay.getSource().addFeatures(d()),l.geolocation.setTracking(!0),a(this).html("<span style='color:green;' class='glyphicon glyphicon-screenshot'></span>")):(l.geolocation.setTracking(!1),l.featuresOverlay.getSource().clear(),a(this).html("<span class='glyphicon glyphicon-screenshot'></span>"))},!1)},M=function(a,b,c,d){var e,f=parseFloat(a),g=parseFloat(b),h=parseFloat(c),i=parseFloat(d),j=[];if(0===f.length||0===g.length||0===h.length||0===i.length)return!1;for(f===-180&&(f+=.1),180===h&&(h=-5),90===i&&(i-=3),g===-90&&(g=35),e=f;e<h;e+=.5)j.push(new ol.geom.Point([e,g]));for(j.push(new ol.geom.Point([h,g])),e=h;e>f;e-=.5)j.push(new ol.geom.Point([e,i]));return j.push(new ol.geom.Point([f,i])),j.push(new ol.geom.Point([f,g])),j},N=function(){a(".wb-tables").trigger("wb-init.wb-tables")},O=function(a,b){var c;return a.getLayers().forEach(function(a){if(b===a.id)return void(c=a)}),c},P=function(a){var b,c=H(a.getAttribute("data-map"));return a.getAttribute("data-layer")?(b=O(c.map,a.getAttribute("data-layer")),[c.map,b,a.getAttribute("data-feature")?b.getSource().getFeatureById(a.getAttribute("data-feature")):null]):[c.map,null,null]},Q=function(){return Math.random().toString(36).slice(2)};i.on("click",".geomap-zoomto",function(b){var c,d,e,f,g,h=b.which,i="A"===b.target.tagName?b.target:a(b.target).closest("a")[0];h&&1!==h||(b.preventDefault(),c=i.getAttribute("data-map"),d=P(i),e=d[2].getGeometry(),f=e.getExtent(),g=d[0].getView(),"Point"===e.getType()?(g.fit(f,d[0].getSize()),g.setZoom(10)):g.fit(f,d[0].getSize()),a("#"+c+" .wb-geomap-map").trigger("setfocus.wb"))}),i.on("geomap.wb",h,m),i.on(d.resizeEvents,function(){k.forEach(function(b){var c=a(b.map.getTargetElement());c.height(c.width()*b.map.get("aspectRatio")),b.map.updateSize()})}),i.on("change",".geomap-cbx",function(b){var c=b.target,d=P(c)[2],e=P(c)[0],f=q(e,ol.interaction.Select),g=a(this).closest("tbody"),h=c.checked;a(g).find(".geomap-cbx").prop("checked",!1),a(g).find(".geomap-cbx").closest("tr").removeClass("active"),f.getFeatures().clear(),h?a(c).closest("tr").addClass("active"):a(c).closest("tr").removeClass("active"),h?(a(c).prop("checked",!0),f.getFeatures().push(d),C(b,d,e)):f.getFeatures().remove(d)}),i.on("focusin focusout mouseover mouseout",".wb-geomap-map",function(b){var c=b.currentTarget,d=b.type,e=c.className.indexOf("active");"mouseover"===d||"focusin"===d?e&&a(c).addClass("active"):e>0&&a(c).removeClass("active")}),n.prototype.addBasemap=function(){var b,c,d,e,g,h,i,j,k=this,l=k.settings.basemap,m=l&&0!==l.length,n={},o=[],p={},q=[];if(k.settings.attribution&&(p.attributions=[new ol.Attribution({html:k.settings.attribution.text})]),m)n.extent=l.mapOptions&&l.mapOptions.maxExtent?l.mapOptions.maxExtent.split(",").map(Number):null,n.projection=l.mapOptions&&l.mapOptions.projection?l.mapOptions.projection:"EPSG:3857",n.center=k.settings&&k.settings.center?ol.proj.transform(k.settings.center,"EPSG:4326",n.projection):l.mapOptions&&l.mapOptions.center?ol.proj.transform(l.mapOptions.center,"EPSG:4326",n.projection):l.mapOptions&&l.mapOptions.maxExtent?ol.extent.getCenter(n.extent):[0,0],n.zoom=k.settings&&k.settings.zoom?k.settings.zoom:l.mapOptions&&l.mapOptions.zoomLevel?l.mapOptions.zoomLevel:2,"wms"===l.type?(b=E(l,["mapOptions","url"]),b.srs=n.projection,b.crs=n.projection,q.push(new ol.layer.Image({extent:n.extent,source:new ol.source.ImageWMS({url:l.url,params:b})}))):"esri"===l.type?(p.url=l.url.replace("/MapServer/export","/MapServer"),q.push(new ol.layer.Tile({extent:n.extent,source:new ol.source.TileArcGISRest(p)}))):"xyz"===l.type?(a.isArray(l.url)?(a.each(l.url,function(a,b){o.push(b.replace(/\${/g,"{"))}),p.urls=o):p.url=l.url.replace(/\${/g,"{"),q.push(new ol.layer.Tile({source:new ol.source.XYZ(p)}))):"osm"===l.type?q.push(new ol.layer.Tile({source:new ol.source.OSM({attributions:[ol.source.OSM.ATTRIBUTION]})})):"mapquest"===l.type&&q.push(new ol.layer.Tile({source:new ol.source.MapQuest({layer:"sat"})}));else{for(d=ol.proj.get("EPSG:3978"),e=[38364.660062653464,22489.62831258996,13229.193125052918,7937.5158750317505,4630.2175937685215,2645.8386250105837,1587.5031750063501,926.0435187537042,529.1677250021168,317.50063500127004,185.20870375074085,111.12522225044451,66.1459656252646,38.36466006265346,22.48962831258996,13.229193125052918,7.9375158750317505,4.6302175937685215],g=this.mapDiv.width(),h=5,g>260&&g<=500?h=1:g>500&&g<=725?h=2:g>725&&g<=1175?h=3:g>1175&&g<=2300&&(h=4),i=h-1;i!==-1;i-=1)e.shift();for(j=new Array(e.length),c=0;c<e.length;++c)j[c]=h+c;n={extent:[-275e4,-9e5,36e5,463e4],resolutions:e,projection:d},q.push(new ol.layer.Tile({source:new ol.source.WMTS({attributions:[new ol.Attribution({html:"<a href='"+f.attribLink+"'>©"+f.attribTitle+"</a>"})],url:"http://geoappext.nrcan.gc.ca/arcgis/rest/services/BaseMaps/CBCT3978/MapServer/WMTS/",layer:f.baseMapTitle,matrixSet:"nativeTileMatrixSet",projection:d,tileGrid:new ol.tilegrid.WMTS({extent:[-275e4,-9e5,36e5,463e4],origin:[-34655800,3931e4],resolutions:e,matrixIds:j}),style:"default"})}))}for(var r=q.length-1;r!==-1;r-=1)k.map.addLayer(q[r]);return F(n)},o.prototype.addToLegend=function(){var b,c,d,e,g,h,i=this,j=this.map.legend.target;b=j.find("fieldset"),0===b.length&&(b=a("<fieldset name='legend'><legend class='wb-inv'>"+f.toggleLayer+"</legend></fieldset>").appendTo(j)),d=this.settings.visible?"checked='checked'":"",c=j.find("ul.geomap-lgnd"),0===c.length&&(c=a("<ul class='list-unstyled geomap-lgnd'></ul>").appendTo(b)),e=a("<input type='checkbox' id='cb_"+this.id+"' class='geomap-lgnd-cbx' value='"+this.id+"' "+d+" data-map='"+this.map.id+"' data-layer='"+this.id+"' />"),e.change(function(){a("#sb_"+i.id).toggle(a(this).is(":checked")),i.toggleVisibility(a(this).is(":checked")),i.map.legend.refresh()}),g=a("<label>",{for:"cb_"+this.id,text:this.settings.title}).prepend(e),h=a("<li class='checkbox geomap-lgnd-layer'>").append(g,"<div id='sb_"+this.id+"'></div>"),c.append(h),this.settings.options&&this.settings.options.legendUrl?a("#sb_"+this.id).append("<img src='"+this.settings.options.legendUrl+"' alt='"+f.geoLgndGrphc+"'/>"):this.settings.options&&this.settings.options.legendHTML?a("#sb_"+this.id).append(this.settings.options.legendHTML):"wms"!==this.settings.type&&this.map.legend.symbolize(this),a("#sb_"+this.id).toggle(this.settings.visible)},n.prototype.addTabularData=function(){var b,d,e,g,h,i,j,k,l,m,n,p,q,r,t,u,v,w,x,y,z,C,D,E,F,G,H,I,J,K="<th><span class='wb-inv'>"+f.zoomFeature+"</span></th>",L="<th><span class='wb-inv'>"+f.select+"</span></th>",N=new ol.format.WKT,O=/<\/?[^>]+>/gi,P=/\W/g;for(F=this.settings.tables.length-1;F!==-1;F-=1)if(d=c.getElementById(this.settings.tables[F].id)){for(b=a(d).wrap("<div data-layer='"+this.settings.tables[F].id+"' class='geomap-table-wrapper'></div>"),e=this.settings.tables[F],g=[],h=[],j=d.getElementsByTagName("th"),l=d.getElementsByTagName("tr"),m=l.length,n=this.settings.useMapControls,b.hasClass("wb-tables")&&"undefined"==typeof b.attr("data-wb-tables")&&b.attr("data-wb-tables",'{ "order": [], "columnDefs": [ { "targets": [ 0, '+(j.length+1)+' ], "orderable": false } ] }'),G=this.settings.tables[F].visible!==!1,k=j.length-1;k!==-1;k-=1)h[k]=j[k].innerHTML.replace(O,"");for(i=b.find("thead tr"),e.zoom&&n&&i.append(K),i.prepend(L),I=s(),H="undefined"==typeof e.style?{strokeColor:I.stroke,fillColor:I.fill}:e.style,m=l.length-1;m!==-1;m-=1){for(p={},q=l[m],r=q.getAttribute("data-type"),v=q.getElementsByTagName("td"),D=v.length-1;D!==-1;D-=1)u=v[D],y=u.getElementsByTagName("script")[0],y&&y.parentNode.removeChild(y),p[h[D]]=u.innerHTML;if(null!==r){if("bbox"===r){
for(z=q.getAttribute("data-geometry").split(","),t=M(z[0],z[1],z[2],z[3]),C="",E=t.length-1;E!==-1;E-=1)C+=t[E].getCoordinates()[0]+" "+t[E].getCoordinates()[1]+", ";C=C.slice(0,-2),x="POLYGON (("+C+"))"}else"wkt"===r&&(x=q.getAttribute("data-geometry"));w=N.readFeature(x,{dataProjection:"EPSG:4326",featureProjection:this.map.getView().getProjection()}),w.setId(Q()),w.layerId=e.id,w.layerTitle=b.attr("aria-label"),q.setAttribute("id",w.getId().replace(P,"_")),a(q).html(A(this,w)+q.innerHTML+(n&&e.zoom?B(this,w):"")),w.attributes=p,g.push(w)}}J=new o(this,{tableId:b.attr("id"),type:"wkt",visible:G,datatable:e.datatable,popupsInfo:e.popupsInfo,popups:e.popups,name:e.id,title:b.attr("aria-label"),features:g,style:H}),this.mapLayers.push(J)}},n.prototype.addMapLayers=function(){var b,c,d=this;d.addTabularData(),a.each(d.settings.overlays,function(a,b){c=new o(d,b),d.mapLayers.push(c)}),b=new ol.layer.Vector({source:new ol.source.Vector,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba( 255, 0, 20, 0.1 )"}),stroke:new ol.style.Stroke({color:"#ff0033",width:2}),image:new ol.style.RegularShape({fill:new ol.style.Fill({color:"#ff0033"}),stroke:new ol.style.Stroke({color:"#ff0033",width:5}),points:4,radius:10,radius2:0,angle:0})})}),b.id="locLayer",d.map.addLayer(b);for(var e=d.mapLayers.length-1;e!==-1;e-=1)d.map.addLayer(d.mapLayers[e].layer)},o.prototype.populateDataTable=function(){function b(){var a=0;for(var b in e)e.hasOwnProperty(b)&&(a+=1);return a}if(this.settings.accessible){var c,d=this,e=d.settings.attributes,g=b(),h=a("<table class='table' aria-label='"+d.settings.title+"' id='"+d.id+"'><caption>"+d.settings.caption+"</caption></table>"),i="<th><span class='wb-inv'>"+f.select+"</span></th>",j="",k=d.layer.getSource().getFeatures();d.settings.datatable?(h.addClass("wb-tables"),h.attr("data-wb-tables",'{ "order": [], "columnDefs": [ { "targets": [ 0, '+(g+1)+' ], "orderable": false } ] }')):h.addClass("table-condensed");for(c in e)e.hasOwnProperty(c)&&(i+="<th>"+e[c]+"</th>");i="<thead><tr>"+i+(d.map.settings.useMapControls&&d.settings.zoom?"<th><span class='wb-inv'>"+f.zoomFeature+"</span></th>":"")+"</tr></thead>";for(var l=0;l<k.length;l+=1){j+="<tr>"+A(d,k[l]),e=k[l].attributes;for(c in e)e.hasOwnProperty(c)&&(j+="<td>"+e[c]+"</td>");j+=d.map.settings.useMapControls&&d.settings.zoom?B(d.map,k[l]):""}return h.append(i,"<tbody>"+j+"</tbody>"),a("div[ data-layer='"+d.id+"'].geomap-table-wrapper").append(h),N(d.map),h}},o.prototype.createOLLayer=function(){var b,c,d,e,f,g,h,i=this,j=i.settings.attributes;if("wms"===i.settings.type){var k=D(i.settings),l=k.options.opacity?k.options.opacity:1;c=new ol.layer.Image({opacity:l,visible:i.settings.visible,source:new ol.source.ImageWMS({url:i.settings.url,params:k})}),i.settings.accessible=!1}else if("wkt"===i.settings.type)d=new t,c=new ol.layer.Vector({visible:i.settings.visible,source:new ol.source.Vector({features:i.settings.features}),style:d.createStyleFunction(i.settings.style,i.settings.featureType)}),i.settings.accessible=!1;else if("kml"===i.settings.type){var m=!i.settings.style;d=new t,b=s(),c=new ol.layer.Vector({visible:i.settings.visible,source:new ol.source.Vector({url:i.settings.url,format:new ol.format.KML({extractStyles:m})})}),"undefined"==typeof i.settings.style&&(i.settings.style={strokeColor:b.stroke,fillColor:b.fill}),c.getSource().once("addfeature",function(a){if(f=a.feature.getGeometry().getType(),!m){var b=d.createStyleFunction(i.settings.style,f);c.setStyle(b)}}),h=c.getSource(),g=h.on("change",function(){if("ready"===h.getState()){h.unByKey(g);for(var a=this.getFeatures(),b=0,d=a.length;b<d;b+=1){var f=a[b];i.settings.style.select&&(f.selectStyle=i.settings.style.select),f.setId(Q()),f.layerId=c.id,f.layerTitle=c.title,e={};for(var k in j)j.hasOwnProperty(k)&&(e[j[k]]=f.getProperties()[k]);f.attributes=e}i.populateDataTable(),i.map.legend.symbolize(i)}},h)}else if("json"===i.settings.type){var n=new ol.source.Vector;d=new t,b=s(),"undefined"==typeof i.settings.style&&(i.settings.style={strokeColor:b.stroke,fillColor:b.fill}),c=i.settings.cluster?new ol.layer.Vector({visible:i.settings.visible,source:new ol.source.Cluster({distance:40,source:n})}):new ol.layer.Vector({visible:i.settings.visible,source:n}),n.once("addfeature",function(){c.setStyle(d.createStyleFunction(i.settings.style,f))});var o=function(b){var d,e,f,g,h,k,l,m,o,p,q=i.settings.root,r=b[q]?b[q]:b;for(r instanceof Array==!1&&(r=a.map(r,function(a){return a})),m=0,o=r.length;m<o;m+=1)if(f=r[m],l||a.each(f,function(a,b){b.coordinates&&(l=a)}),f[l]){if(g=f[l].coordinates[0],"Polygon"===f[l].type&&5===g.length){e=M(g[1][0],g[1][1],g[3][0],g[3][1]);for(var s=[],t=0,u=e.length;t<u;t+=1){var v=e[t];s.push(v.getCoordinates())}h=new ol.geom.Polygon([s])}else"Point"===f[l].type?h=new ol.geom.Point([f[l].coordinates[1],f[l].coordinates[0]]):"LineString"===f[l].type&&(h=new ol.geom.LineString(f[l].coordinates));k=h.transform("EPSG:4326",i.map.map.getView().getProjection()),d={};for(var w in j)p=null,j.hasOwnProperty(w)&&(p=j[w].path,p?d[j[w].alias]=f[w]?f[w][p]:"":d[j[w]]=f[w]?f[w]:"");f=new ol.Feature,f.setId(Q()),f.layerId=c.id,f.layerTitle=c.title,f.attributes=d,f.setGeometry(k),n.addFeature(f)}i.populateDataTable(),i.map.legend.symbolize(i)};a.getJSON(i.settings.url,i.settings.params,o)}else if("geojson"===i.settings.type||"esrijson"===i.settings.type||"topojson"===i.settings.type){var p;d=new t,b=s(),"undefined"==typeof i.settings.style&&(i.style={strokeColor:b.stroke,fillColor:b.fill}),p=i.settings.params?i.settings.url+"?"+a.param(i.settings.params):i.settings.url,c="geojson"===i.settings.type?new ol.layer.Vector({visible:i.settings.visible,source:new ol.source.Vector({url:p,format:new ol.format.GeoJSON,strategy:ol.loadingstrategy.bbox})}):"topojson"===i.settings.type?new ol.layer.Vector({visible:i.settings.visible,source:new ol.source.Vector({url:p,format:new ol.format.TopoJSON})}):new ol.layer.Vector({visible:i.settings.visible,source:new ol.source.Vector({url:p,format:new ol.format.EsriJSON,strategy:ol.loadingstrategy.bbox})}),c.getSource().once("addfeature",function(a){f=a.feature.getGeometry().getType();var b=d.createStyleFunction(i.settings.style,f);c.setStyle(b)}),h=c.getSource(),g=h.on("change",function(){if("ready"===h.getState()){h.unByKey(g);for(var a=this.getFeatures(),b=0,d=a.length;b<d;b+=1){var f=a[b];f.setId(Q()),f.layerId=c.id,f.layerTitle=c.title,e={};for(var k in j)j.hasOwnProperty(k)&&(e[j[k]]=f.getProperties()[k]);f.attributes=e}i.populateDataTable(),i.map.legend.symbolize(i)}},h)}return c.id=i.id,c.title=i.settings.title,c.datatable=i.settings.datatable,c.popupsInfo=i.settings.popupsInfo,c.popups=i.settings.popups,c},o.prototype.toggleVisibility=function(b){var c=a("div[ data-layer='"+this.id+"' ].geomap-table-wrapper");b?(c.fadeIn(),c.parent().find(".layer-msg").remove()):(c.fadeOut(),c.parent().append("<div class='layer-msg'><p>"+f.hiddenLayer+"</p></div>").fadeIn()),this.layer.setVisible(b)},n.prototype.loadControls=function(){var b,d,e,g,h=this,i=h.map,j=!1;if(g=new ol.interaction.Select({layers:h.layers}),g.on("select",function(b){b.selected.length>0&&"undefined"!=typeof b.selected[0].layerTitle&&(j=O(this.getMap(),b.selected[0].layerId).popups,a("#cb_"+b.selected[0].getId()).prop("checked",!0).closest("tr").addClass("active"),b.selected[0].layerTitle=this.getLayer(b.selected[0]).title,j&&C(b,b.selected[0],i)),b.deselected.length>0&&a("#cb_"+b.deselected[0].getId()).prop("checked",!1).closest("tr").removeClass("active"),0===b.selected.length&&C(b,null,i)},g),i.getInteractions().extend([g]),h.settings.useMapControls){var k=c.createElement("span");k.className="glyphicon glyphicon-fullscreen",b=new ol.control.ZoomToExtent({extent:i.getView().calculateExtent(i.getSize()),label:k}),i.addControl(b),b.element.setAttribute("aria-label",f.zoomworld),b.element.setAttribute("title",f.zoomworld),h.settings.useMousePosition&&(d=new ol.control.MousePosition({coordinateFormat:ol.coordinate.createStringXY(4),projection:"EPSG:4326",undefinedHTML:""}),i.addControl(d),d.element.setAttribute("aria-label",f.mouseposition),d.element.setAttribute("title",f.mouseposition)),h.settings.useScaleLine&&(e=new ol.control.ScaleLine,i.addControl(e),e.element.setAttribute("aria-label",f.scaleline),e.element.setAttribute("title",f.scaleline))}h.settings.useGeocoder&&new K(h),h.settings.useAOI&&new I(h),h.settings.useGeolocation&&h.map.addControl(new L({projection:h.map.getView().getProjection()}))},n.prototype.createPopup=function(){var b,d,e,g=this;e=a("<div id='popup-"+g.mapDiv.attr("id")+"' class='ol-popup'></div>"),b=a("<a href='#' title='"+f.dismiss+"' class='ol-popup-closer' role='button'>&#xd7;<span class='wb-inv'>"+f.dismiss+"</span></a>"),e.append(b,"<div class='popup-content'></div>"),a("#"+g.mapDiv.attr("id")).append(e),d=new ol.Overlay({element:c.getElementById("popup-"+g.mapDiv.attr("id")),autoPan:!0,autoPanAnimation:{duration:250}}),b.on("click",function(a){return a.preventDefault(),d.setPosition(void 0),this.blur(),!1}),g.map.addOverlay(d)},n.prototype.accessibilize=function(){var a=this,b=a.mapDiv.find(".ol-zoom-in"),c=a.mapDiv.find(".ol-zoom-out");b.attr("aria-label",f.zoomin),b.attr("title",f.zoomin),c.attr("aria-label",f.zoomout),c.attr("title",f.zoomout),a.mapDiv.attr({tabindex:"0","data-map":a.id}),a.mapDiv.attr({role:"dialog","aria-label":f.ariaMap}),new J(a)},p.prototype.symbolize=function(b){var c,d,e,f,g,h,i,j,k=this,l=b.settings.style,m=b.id,n=b.layer.getSource().getFeatures()[0],o=[],p="",q="";if("undefined"!=typeof l&&l.rule){if(d=l.rule.length)for(g=0;g!==d;g+=1){if(i=l.rule[g],c=i.filter,e=i.init,q="",j="ls_"+m+"_"+g,c&&!i.name)if(c.name)q=c.name;else switch(c){case"EQUAL_TO":q=i.field+" = "+i.value[0];break;case"GREATER_THAN":q=i.field+" > "+i.value[0];break;case"LESS_THAN":q=i.field+" < "+i.value[0];break;case"BETWEEN":q=i.field+" "+i.value[0]+" - "+i.value[1]}else i&&i.name&&(q=i.name);p+="<li><div class='geomap-legend-element'><div id='"+j+"' class='geomap-legend-symbol'></div><span class='geomap-legend-symbol-text'><small>"+q+"</small></span></div></li>",o.push({id:j,feature:n,symbolizer:e})}}else if("undefined"!=typeof l&&"unique"===l.type){g=0;for(var r in l.init)j="ls_"+m+"_"+g,e=l.init[r],q=e.name?e.name:r,p+="<li><div class='geomap-legend-element'><div id='"+j+"' class='geomap-legend-symbol'></div><span class='geomap-legend-symbol-text'><small>"+q+"</small></span></div></li>",o.push({id:j,feature:n,symbolizer:e}),g+=1}else"undefined"!=typeof l&&"symbol"===l.type?(j="ls_"+m+"_0",e=l.init,q=e.name?e.name:"",p+="<li><div class='geomap-legend-element'><div id='"+j+"' class='geomap-legend-symbol'></div><span class='geomap-legend-symbol-text'><small>"+q+"</small></span></div></li>",o.push({id:j,feature:n,symbolizer:e})):(j="ls_"+m+"_0",e={fillColor:l.fillColor,strokeColor:l.strokeColor,strokeWidth:l.strokeWidth,strokeDash:l.strokeDash},p+="<li><div class='geomap-legend-element'><div id='"+j+"' class='geomap-legend-symbol'></div><span class='geomap-legend-symbol-text'><small>"+q+"</small></span></div></li>",o.push({id:j,feature:n,symbolizer:e}));for(a("#sb_"+m).html("<ul class='list-unstyled'>"+p+"</ul>"),f=0,h=o.length;f!==h;f+=1){var s=o[f];k.getSymbol(s.id,s.feature,s.symbolizer)}},p.prototype.getSymbol=function(a,b,c){var d,e,f,g,h=s(),i=b&&b.getGeometry()?b.getGeometry().getType():"Polygon",j=c.fillOpacity?c.fillOpacity:c.graphicOpacity?c.graphicOpacity:1,k=c.fillColor?z(c.fillColor,j):h.transparent,l=c.pointRadius?c.pointRadius:5,m=c.strokeColor?z(c.strokeColor):h.transparent,n=c.strokeWidth?c.strokeWidth:1,o=c.strokeDash?c.strokeDash:[1,0],p=c.externalGraphic?c.externalGraphic:null,q=c.graphicName?c.graphicName:null,t=c.graphicHeight?c.graphicHeight:30,A=c.graphicWidth?c.graphicWidth:30,B=t<2*l?2*l:t,C=A<2*l?2*l:A;switch(i){case"Polygon":d=new ol.Feature({geometry:new ol.geom.Polygon([[[-10,-7],[10,-7],[10,7],[-10,7]]])}),g=x({fill:new ol.style.Fill({color:k}),stroke:new ol.style.Stroke({color:m,width:n,lineDash:o})}),d.setStyle(g);break;case"Point":d=new ol.Feature({geometry:new ol.geom.Point([0,0])}),g=q?u({symbol:q,fill:new ol.style.Fill({color:k}),stroke:new ol.style.Stroke({color:m,lineDash:o}),radius:l}):p?v({src:p,opacity:j,size:[A,t]}):w({radius:l,fill:new ol.style.Fill({color:k}),stroke:new ol.style.Stroke({color:m,width:n,lineDash:o})}),d.setStyle(g);break;case"LineString":d=new ol.Feature({geometry:new ol.geom.LineString([[-9,-4],[-4,4],[4,-4],[9,4]])}),g=y({stroke:new ol.style.Stroke({color:m,width:n,lineDash:o})}),d.setStyle(g);break;default:d=new ol.Feature({geometry:new ol.geom.Polygon([[[-10,-7],[10,-7],[10,7],[-10,7]]])}),g=x({fill:new ol.style.Fill({color:k}),stroke:new ol.style.Stroke({color:m,width:n,lineDash:o})}),d.setStyle(g)}e=new ol.Map({controls:[],interactions:[],layers:[new ol.layer.Vector({source:new ol.source.Vector})]}),e&&(this.symbolMapArray.push(e),f=e.getLayers().item(0).getSource(),f.clear(),f.addFeature(d)),e.setTarget(a),r(a,e,d,C,B)},p.prototype.refresh=function(){if(0!==this.symbolMapArray.length){var b,c;for(b=this.symbolMapArray.length-1;b!==-1;b-=1)c=this.symbolMapArray[b],a("#"+c.getTarget()).is(":visible")&&c.updateSize()}},ol.inherits(L,ol.control.Control),ol.inherits(J,ol.control.Control),ol.inherits(K,ol.control.Control)}(jQuery,window,document,wb);